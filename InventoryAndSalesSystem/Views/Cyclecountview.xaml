<UserControl x:Class="InventoryAndSalesSystem.Views.CycleCountView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,15">
            <TextBlock Text="Cycle Count" FontSize="22" FontWeight="Bold" Margin="0,0,0,5"/>
            <TextBlock Text="Compare physical stock against system records and identify variances"
                       FontSize="12" Foreground="Gray"/>
        </StackPanel>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="260"/>
                <ColumnDefinition Width="15"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Sessions -->
            <Border Grid.Column="0" Background="White" BorderBrush="#E0E0E0"
                    BorderThickness="1" CornerRadius="6" Padding="15">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top">
                        <TextBlock Text="Sessions" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <TextBlock Text="Notes (optional)" FontSize="11" Foreground="Gray" Margin="0,0,0,3"/>
                        <TextBox Text="{Binding NewSessionNotes, UpdateSourceTrigger=PropertyChanged}"
                                 Height="55" Padding="8" TextWrapping="Wrap" AcceptsReturn="True"
                                 Margin="0,0,0,8"/>
                        <Button Content="+ Start New Count"
                                Command="{Binding NewSessionCommand}"
                                Style="{StaticResource PrimaryButton}"
                                Height="36" Margin="0,0,0,12"/>
                        <Separator Margin="0,0,0,10"/>
                        <TextBlock Text="Previous Sessions" FontWeight="SemiBold" Margin="0,0,0,5"/>
                    </StackPanel>

                    <ListBox ItemsSource="{Binding Sessions}"
                             SelectedItem="{Binding SelectedSession}"
                             BorderThickness="0" Background="Transparent">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="8,6" Margin="0,2">
                                    <StackPanel>
                                        <TextBlock Text="{Binding StartDate, StringFormat='MM/dd/yyyy hh:mm tt'}"
                                                   FontWeight="SemiBold" FontSize="12"/>
                                        <Border CornerRadius="3" Padding="4,1" Margin="0,3,0,0"
                                                HorizontalAlignment="Left">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="Open">
                                                            <Setter Property="Background" Value="#E3F2FD"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="Completed">
                                                            <Setter Property="Background" Value="#E8F5E9"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding Status}" FontSize="10" FontWeight="SemiBold">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Status}" Value="Open">
                                                                <Setter Property="Foreground" Value="#1565C0"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Status}" Value="Completed">
                                                                <Setter Property="Foreground" Value="#2E7D32"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </Border>
                                        <TextBlock Text="{Binding Notes}" FontSize="10" Foreground="Gray"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Right Panel: Placeholder (no session selected) -->
            <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Center">
                <StackPanel.Style>
                    <Style TargetType="StackPanel">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedSession}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </StackPanel.Style>
                <TextBlock Text="&#x1F4CB;" FontSize="48" HorizontalAlignment="Center"/>
                <TextBlock Text="Select a session or start a new count"
                           FontSize="16" Foreground="Gray" HorizontalAlignment="Center" Margin="0,10,0,0"/>
            </StackPanel>

            <!-- Right Panel: Session content (visible only when a session is selected) -->
            <Grid Grid.Column="2">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedSession}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Summary Cards -->
                <Grid Grid.Row="0" Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Border Grid.Column="0" Background="#1976D2" CornerRadius="6" Padding="15,10">
                        <StackPanel>
                            <TextBlock Text="Total Items" Foreground="White" FontSize="11"/>
                            <TextBlock Text="{Binding TotalItems}" Foreground="White" FontSize="24" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="2" Background="#388E3C" CornerRadius="6" Padding="15,10">
                        <StackPanel>
                            <TextBlock Text="Counted" Foreground="White" FontSize="11"/>
                            <TextBlock Text="{Binding CountedItems}" Foreground="White" FontSize="24" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="4" Background="#F57C00" CornerRadius="6" Padding="15,10">
                        <StackPanel>
                            <TextBlock Text="Pending" Foreground="White" FontSize="11"/>
                            <TextBlock Text="{Binding PendingItems}" Foreground="White" FontSize="24" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="6" CornerRadius="6" Padding="15,10">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="#7B1FA2"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding VarianceItems}" Value="0">
                                        <Setter Property="Background" Value="#546E7A"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <StackPanel>
                            <TextBlock Text="Variances" Foreground="White" FontSize="11"/>
                            <TextBlock Text="{Binding VarianceItems}" Foreground="White" FontSize="24" FontWeight="Bold"/>
                            <TextBlock Text="{Binding TotalVarianceValue, StringFormat='&#x20B1;{0:N2}'}"
                                       Foreground="White" FontSize="10"/>
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Count Entry Panel -->
                <Border Grid.Row="1" Background="White" BorderBrush="#E0E0E0"
                        BorderThickness="1" CornerRadius="6" Padding="15" Margin="0,0,0,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="15"/>
                            <ColumnDefinition Width="150"/>
                            <ColumnDefinition Width="15"/>
                            <ColumnDefinition Width="200"/>
                            <ColumnDefinition Width="15"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Selected Item" FontSize="11" Foreground="Gray" Margin="0,0,0,3"/>
                            <TextBlock Text="{Binding SelectedItem.ProductName, FallbackValue='(select a row below)'}"
                                       FontWeight="SemiBold" FontSize="14"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Physical Count *" FontSize="11" Foreground="Gray" Margin="0,0,0,3"/>
                            <TextBox Text="{Binding PhysicalCount, UpdateSourceTrigger=PropertyChanged}"
                                     Height="35" Padding="8" FontSize="14"
                                     IsEnabled="{Binding IsSessionOpen}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="4">
                            <TextBlock Text="Notes" FontSize="11" Foreground="Gray" Margin="0,0,0,3"/>
                            <TextBox Text="{Binding CountNotes, UpdateSourceTrigger=PropertyChanged}"
                                     Height="35" Padding="8"
                                     IsEnabled="{Binding IsSessionOpen}"/>
                        </StackPanel>

                        <Button Grid.Column="6"
                                Content="Save Count"
                                Command="{Binding SaveCountCommand}"
                                Style="{StaticResource PrimaryButton}"
                                Height="35" VerticalAlignment="Bottom"/>

                        <Button Grid.Column="8"
                                Content="Complete Session"
                                Command="{Binding CompleteSessionCommand}"
                                Background="#7B1FA2" Foreground="White"
                                Padding="12,8" Margin="5" Cursor="Hand"
                                FontWeight="SemiBold" BorderThickness="0"
                                Height="35" VerticalAlignment="Bottom"/>
                    </Grid>
                </Border>

                <!-- Count Sheet DataGrid -->
                <Border Grid.Row="2" Background="White" BorderBrush="#E0E0E0"
                        BorderThickness="1" CornerRadius="6" Padding="15">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" Text="Count Sheet"
                                   FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>
                        <DataGrid ItemsSource="{Binding SessionItems}"
                                  SelectedItem="{Binding SelectedItem}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  GridLinesVisibility="Horizontal"
                                  HeadersVisibility="Column"
                                  AlternatingRowBackground="#F5F5F5">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Product" Binding="{Binding ProductName}" Width="*" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Category" Binding="{Binding Category}" Width="100" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Expected" Binding="{Binding ExpectedQty}" Width="80" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Counted" Binding="{Binding CountedQty}" Width="80" IsReadOnly="True"/>
                                <DataGridTextColumn Header="Variance" Binding="{Binding Variance}" Width="80" IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="FontWeight" Value="Bold"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding HasVariance}" Value="True">
                                                    <Setter Property="Foreground" Value="#D32F2F"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Variance &#x20B1;" Binding="{Binding VarianceValue, StringFormat='&#x20B1;{0:N2}'}" Width="100" IsReadOnly="True"/>
                                <DataGridTemplateColumn Header="Status" Width="90">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="3" Padding="4,2" Margin="2" HorizontalAlignment="Center">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding VarianceStatus}" Value="Pending">
                                                                <Setter Property="Background" Value="#FFF3E0"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding VarianceStatus}" Value="OK">
                                                                <Setter Property="Background" Value="#E8F5E9"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding VarianceStatus}" Value="Overage">
                                                                <Setter Property="Background" Value="#E3F2FD"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding VarianceStatus}" Value="Shortage">
                                                                <Setter Property="Background" Value="#FFEBEE"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding VarianceStatus}" FontSize="10" FontWeight="SemiBold">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding VarianceStatus}" Value="Pending">
                                                                    <Setter Property="Foreground" Value="#E65100"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding VarianceStatus}" Value="OK">
                                                                    <Setter Property="Foreground" Value="#2E7D32"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding VarianceStatus}" Value="Overage">
                                                                    <Setter Property="Foreground" Value="#1565C0"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding VarianceStatus}" Value="Shortage">
                                                                    <Setter Property="Foreground" Value="#C62828"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Notes" Binding="{Binding Notes}" Width="120" IsReadOnly="True"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DockPanel>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>